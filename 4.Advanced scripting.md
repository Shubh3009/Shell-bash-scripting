# **ðŸ“š AWS EC2 Creation Script Tutorial**

## **Part 1: Concepts Used in This Script**

### **1. AWS EC2 (Elastic Compute Cloud)**
- **What**: Virtual servers in the cloud
- **Analog**: Like renting a computer in AWS's data center
- **Key components**:
  - **AMI (Amazon Machine Image)**: Template for the server (OS + software)
  - **Instance Type**: CPU/RAM specs (t2.micro = 1GB RAM, 1 CPU)
  - **Key Pair**: SSH key for secure login
  - **Security Group**: Virtual firewall rules
  - **Subnet**: Network segment in a VPC

### **2. AWS CLI (Command Line Interface)**
- **What**: Tool to control AWS services from terminal
- **Example commands**:
  ```bash
  aws ec2 describe-instances  # List all EC2 instances
  aws ec2 run-instances       # Create new instance
  aws --version               # Check version
  ```

### **3. Shell Script Concepts Used**
- **`set -euo pipefail`**: Strict error handling mode
- **Functions**: Modular code blocks
- **Conditionals**: `if` statements for checks
- **Loops**: `while` loop for waiting
- **Command substitution**: `$(command)` to capture output
- **Exit codes**: `exit 1` for errors, `exit 0` for success

---

## **Part 2: Script Breakdown**

### **Script Overview**
This script automates AWS EC2 instance creation with proper error handling.

---

### **Line-by-Line Explanation**

#### **1. Shebang & Strict Mode**
```bash
#!/bin/bash
set -euo pipefail
```
- **`#!/bin/bash`**: Use Bash shell
- **`set -e`**: Exit immediately if any command fails
- **`set -u`**: Treat undefined variables as errors
- **`set -o pipefail`**: Pipeline fails if any part fails

#### **2. Function 1: Check AWS CLI**
```bash
check_awscli() {
    if ! command -v aws &> /dev/null; then
        echo "AWS CLI is not installed. Please install it first." >&2
        exit 1
    fi
}
```
- **`command -v aws`**: Check if `aws` command exists
- **`&> /dev/null`**: Suppress output (send to "nowhere")
- **`>&2`**: Print error message to stderr (not stdout)
- **Purpose**: Ensure AWS CLI is installed before proceeding

#### **3. Function 2: Install AWS CLI**
```bash
install_awscli() {
    echo "Installing AWS CLI v2 on Linux..."
    
    curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    sudo apt-get install -y unzip &> /dev/null
    unzip -q awscliv2.zip
    sudo ./aws/install
    
    aws --version
    
    rm -rf awscliv2.zip ./aws
}
```
**Steps:**
1. **Download**: `curl -s` (silent) downloads AWS CLI zip
2. **Install unzip**: `apt-get install -y unzip`
3. **Extract**: `unzip -q` (quiet) the downloaded file
4. **Install**: Run installer script
5. **Verify**: Check version to confirm install
6. **Cleanup**: Remove downloaded files

#### **4. Function 3: Wait for Instance**
```bash
wait_for_instance() {
    local instance_id="$1"
    echo "Waiting for instance $instance_id to be in running state..."
    
    while true; do
        state=$(aws ec2 describe-instances --instance-ids "$instance_id" \
                --query 'Reservations[0].Instances[0].State.Name' --output text)
        if [[ "$state" == "running" ]]; then
            echo "Instance $instance_id is now running."
            break
        fi
        sleep 10
    done
}
```
**How it works:**
- **`local instance_id="$1"`**: Get first argument as instance ID
- **`while true`**: Infinite loop
- **`aws ec2 describe-instances`**: Check instance status
- **`--query`**: JMESPath query to extract state
- **`--output text`**: Get plain text output (not JSON)
- **Polling**: Check every 10 seconds until "running"

#### **5. Function 4: Create EC2 Instance**
```bash
create_ec2_instance() {
    local ami_id="$1"
    local instance_type="$2"
    local key_name="$3"
    local subnet_id="$4"
    local security_group_ids="$5"
    local instance_name="$6"
    
    instance_id=$(aws ec2 run-instances \
        --image-id "$ami_id" \
        --instance-type "$instance_type" \
        --key-name "$key_name" \
        --subnet-id "$subnet_id" \
        --security-group-ids "$security_group_ids" \
        --tag-specifications "ResourceType=instance,Tags=[{Key=Name,Value=$instance_name}]" \
        --query 'Instances[0].InstanceId' \
        --output text
    )
    
    if [[ -z "$instance_id" ]]; then
        echo "Failed to create EC2 instance." >&2
        exit 1
    fi
    
    echo "Instance $instance_id created successfully."
    wait_for_instance "$instance_id"
}
```
**Parameters needed:**
1. **AMI_ID**: OS image (e.g., Ubuntu, Amazon Linux)
2. **INSTANCE_TYPE**: Size (t2.micro, t2.large, etc.)
3. **KEY_NAME**: SSH key pair name
4. **SUBNET_ID**: Network subnet
5. **SECURITY_GROUP_IDS**: Firewall rules
6. **INSTANCE_NAME**: Tag name for the instance

**AWS CLI breakdown:**
```bash
aws ec2 run-instances \
    --image-id "ami-12345" \          # OS image
    --instance-type "t2.micro" \      # Size
    --key-name "my-key" \            # SSH key
    --subnet-id "subnet-abc" \       # Network
    --security-group-ids "sg-123" \  # Firewall
    --tag-specifications \           # Name tag
        "ResourceType=instance,Tags=[{Key=Name,Value=MyServer}]"
```

#### **6. Main Function**
```bash
main() {
    check_awscli || install_awscli
    
    echo "Creating EC2 instance..."
    
    AMI_ID=""  # Need to fill these!
    INSTANCE_TYPE="t2.micro"
    KEY_NAME=""
    SUBNET_ID=""
    SECURITY_GROUP_IDS=""
    INSTANCE_NAME="Shell-Script-EC2-Demo"
    
    create_ec2_instance "$AMI_ID" "$INSTANCE_TYPE" "$KEY_NAME" \
                       "$SUBNET_ID" "$SECURITY_GROUP_IDS" "$INSTANCE_NAME"
    
    echo "EC2 instance creation completed."
}

main "$@"
```
**Flow:**
1. Check/install AWS CLI
2. Set parameters (currently empty - need values)
3. Call create function
4. Wait for instance to be ready

---

## **Part 3: How to Use This Script**

### **Step 1: Fill Required Values**
You need AWS resources first:
```bash
# Get AMI ID (Ubuntu 22.04 in us-east-1)
AMI_ID="ami-0c55b159cbfafe1f0"

# Create key pair in AWS Console first, then use name
KEY_NAME="my-ssh-key"

# Get subnet ID from VPC section
SUBNET_ID="subnet-0abc123def456"

# Create security group, then get ID
SECURITY_GROUP_IDS="sg-0123456789abcdef0"
```

### **Step 2: Configure AWS Credentials**
```bash
# Run before script
aws configure
# Enter: Access Key, Secret Key, Region, Output format
```

### **Step 3: Run Script**
```bash
# Make executable
chmod +x create_ec2.sh

# Run
./create_ec2.sh
```

---

## **Part 4: Visual Flowchart**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Start Script  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check AWS CLI   â”‚
â”‚    Installed?   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    No  â”‚   Yes
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ Install  â”‚
    â”‚ AWS CLI  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Set EC2 Params  â”‚
â”‚ (AMI, Key, etc) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create Instance â”‚
â”‚  via AWS CLI    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Poll Status    â”‚
â”‚ Every 10 sec    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ Running?â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    No   â”‚   Yes
    â”‚    â””â”€â”€â”€â”€â”€â”
    â”‚     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â””â”€â”€â”€â”€â”€â”¤ Sleep   â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ 10 sec  â”‚â”€â”€â”€â”€â”€â–ºâ”‚ Success!    â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ Instance Up â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## **Part 5: Complete Example with Real Values**

```bash
#!/bin/bash
set -euo pipefail

# ... [all functions remain same] ...

main() {
    check_awscli || install_awscli
    
    echo "Creating EC2 instance..."
    
    # EXAMPLE VALUES - Replace with yours!
    AMI_ID="ami-0c55b159cbfafe1f0"  # Ubuntu 22.04 in us-east-1
    INSTANCE_TYPE="t2.micro"
    KEY_NAME="my-ec2-key"           # Must exist in AWS
    SUBNET_ID="subnet-0a1b2c3d4e5f67890"
    SECURITY_GROUP_IDS="sg-0123456789abcdef0 sg-abcdef0123456789"  # Can have multiple
    INSTANCE_NAME="Production-Webserver-01"
    
    create_ec2_instance "$AMI_ID" "$INSTANCE_TYPE" "$KEY_NAME" \
                       "$SUBNET_ID" "$SECURITY_GROUP_IDS" "$INSTANCE_NAME"
    
    # Get public IP
    PUBLIC_IP=$(aws ec2 describe-instances \
        --instance-ids "$instance_id" \
        --query 'Reservations[0].Instances[0].PublicIpAddress' \
        --output text)
    
    echo "Public IP: $PUBLIC_IP"
    echo "Connect with: ssh -i ~/.ssh/my-ec2-key.pem ubuntu@$PUBLIC_IP"
    
    echo "EC2 instance creation completed."
}

main "$@"
```

---

## **ðŸš¨ Common Issues & Solutions**

### **Issue 1: "aws: command not found"**
**Solution**: Script installs AWS CLI automatically

### **Issue 2: "Invalid AMI ID"**
**Solution**: Find correct AMI for your region:
```bash
aws ec2 describe-images \
    --owners amazon \
    --filters "Name=name,Values=ubuntu*" \
    --query 'Images[*].[ImageId,Name]' \
    --output table
```

### **Issue 3: "Invalid key pair"**
**Solution**: Create key pair first:
```bash
aws ec2 create-key-pair \
    --key-name "my-key" \
    --query 'KeyMaterial' \
    --output text > my-key.pem
chmod 400 my-key.pem
```

### **Issue 4: "No permissions"**
**Solution**: Ensure IAM user has `AmazonEC2FullAccess` policy

---

## **ðŸ“Š AWS CLI Commands Used**

| Command | Purpose | Example Output |
|---------|---------|----------------|
| `aws --version` | Check CLI version | `aws-cli/2.13.0` |
| `aws ec2 run-instances` | Create instance | `i-1234567890abcdef0` |
| `aws ec2 describe-instances` | Check status | `running` or `pending` |
| `aws ec2 describe-images` | List AMIs | Shows available OS images |

---

## **âœ… Key Takeaways**

1. **Automation**: Script automates manual AWS Console steps
2. **Error handling**: `set -euo pipefail` catches failures early
3. **Polling**: Script waits for AWS operations to complete
4. **Modular**: Functions make code reusable and testable
5. **Real-world**: This is actual DevOps automation used in production

**This script demonstrates real Infrastructure-as-Code (IaC) practices!** ðŸš€
